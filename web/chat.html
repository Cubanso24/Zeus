<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeus - Splunk Query Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e0e0e0;
        }

        .main-container {
            display: flex;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            gap: 20px;
        }

        /* History Sidebar */
        .history-sidebar {
            width: 280px;
            background: #1e1e2e;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .history-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: 600;
            text-align: center;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            background: #2a2a3e;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            border-left: 3px solid #667eea;
        }

        .history-item:hover {
            background: #353549;
        }

        .history-item-time {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        .history-search {
            padding: 8px 10px;
            border-bottom: 1px solid #3a3a4e;
        }

        .history-search input {
            width: 100%;
            padding: 8px 12px;
            background: #1a1a2e;
            border: 1px solid #3a3a4e;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
        }

        .history-search input:focus {
            outline: none;
            border-color: #667eea;
        }

        .history-search input::placeholder {
            color: #666;
        }

        /* Explanation Format Toggle */
        .format-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #2a2a3e;
            border-radius: 8px;
            margin: 10px;
            border: 1px solid #3a3a4e;
        }

        .format-toggle-label {
            font-size: 11px;
            color: #888;
        }

        .format-toggle-btn {
            padding: 4px 10px;
            border: 1px solid #3a3a4e;
            background: transparent;
            color: #888;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .format-toggle-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .format-toggle-btn:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        /* Index Selector */
        .index-selector {
            padding: 10px;
            margin: 10px;
            background: #2a2a3e;
            border-radius: 8px;
            border: 1px solid #3a3a4e;
        }

        .index-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .index-selector-label {
            font-size: 11px;
            color: #888;
            font-weight: 600;
        }

        .index-selector-add {
            padding: 2px 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }

        .index-selector-add:hover {
            background: #5a6fd6;
        }

        .index-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .index-tag {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #3a3a4e;
            border-radius: 4px;
            font-size: 11px;
            color: #e0e0e0;
        }

        .index-tag.active {
            background: #667eea;
        }

        .index-tag-remove {
            cursor: pointer;
            color: #888;
            font-size: 14px;
            line-height: 1;
        }

        .index-tag-remove:hover {
            color: #dc3545;
        }

        .index-input-row {
            display: flex;
            gap: 4px;
        }

        .index-input {
            flex: 1;
            padding: 6px 8px;
            background: #1a1a2e;
            border: 1px solid #3a3a4e;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 11px;
        }

        .index-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .index-input::placeholder {
            color: #666;
        }

        /* Stop Button */
        .stop-btn {
            padding: 12px 24px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: none;
        }

        .stop-btn:hover {
            background: #c82333;
        }

        /* Main Chat Container */
        .container {
            flex: 1;
            background: #1e1e2e;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #16162a;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message.assistant .message-content {
            background: #2a2a3e;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        .message.assistant .message-content.clarification {
            background: #3d3520;
            border-color: #ffc107;
        }

        .query-code {
            background: #1a1a1a;
            color: #00ff00;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            border: 1px solid #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Learn Mode Styles */
        .learn-response {
            line-height: 1.6;
        }

        .learn-response h3 {
            color: #667eea;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .learn-response h4 {
            color: #888;
            margin-top: 12px;
            margin-bottom: 8px;
            font-size: 13px;
            text-transform: uppercase;
        }

        .learn-response ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .learn-response li {
            margin-bottom: 4px;
        }

        .learn-response code {
            background: #1a1a2e;
            padding: 2px 6px;
            border-radius: 4px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        .learn-response pre.query-code {
            margin: 10px 0;
        }

        .clarification-tag {
            display: inline-block;
            background: #ffc107;
            color: #1a1a2e;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .input-container {
            padding: 20px;
            background: #1e1e2e;
            border-top: 1px solid #3a3a4e;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        #userInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #3a3a4e;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            background: #2a2a3e;
            color: #e0e0e0;
        }

        #userInput:focus {
            border-color: #667eea;
        }

        #sendBtn, #generateAltBtn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #sendBtn:hover, #generateAltBtn:hover {
            transform: scale(1.05);
        }

        #sendBtn:disabled, #generateAltBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: scale(1);
        }

        #generateAltBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-size: 12px;
            padding: 8px 16px;
        }

        .button-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #3a3a4e;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .examples {
            padding: 10px 0;
            font-size: 12px;
            color: #999;
        }

        .example-chip {
            display: inline-block;
            background: #2a2a3e;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 12px;
            margin: 4px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid #3a3a4e;
        }

        .example-chip:hover {
            background: #353549;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
            margin-right: 8px;
        }

        .copy-btn:hover {
            background: #218838;
        }

        /* Query Explanation Styles */
        .explanation-section {
            margin-top: 15px;
            padding: 12px 15px;
            background: #252538;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .explanation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #667eea;
            font-size: 13px;
        }

        .explanation-text {
            color: #c0c0c0;
            font-size: 13px;
            line-height: 1.7;
        }

        .explanation-text .summary {
            margin-bottom: 12px;
            color: #e0e0e0;
        }

        .explanation-text .section-header {
            font-weight: 600;
            color: #667eea;
            margin-top: 12px;
            margin-bottom: 6px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .explanation-text ul {
            margin: 0;
            padding-left: 18px;
        }

        .explanation-text li {
            margin-bottom: 4px;
        }

        .explanation-toggle {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
        }

        .explanation-toggle:hover {
            background: #667eea;
            color: white;
        }

        /* Feedback buttons */
        .feedback-container {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .feedback-btn {
            background: transparent;
            border: 2px solid #3a3a4e;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-btn:hover {
            transform: scale(1.1);
        }

        .feedback-btn.good {
            border-color: #28a745;
            color: #28a745;
        }

        .feedback-btn.good.selected {
            background: #28a745;
            color: white;
        }

        .feedback-btn.bad {
            border-color: #dc3545;
            color: #dc3545;
        }

        .feedback-btn.bad.selected {
            background: #dc3545;
            color: white;
        }

        .feedback-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .feedback-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .correction-input {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #3a3a4e;
            border-radius: 6px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .correction-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-feedback-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
        }

        .submit-feedback-btn:hover {
            background: #764ba2;
        }

        .feedback-status {
            font-size: 11px;
            color: #28a745;
            margin-top: 4px;
        }

        /* Cached Query Badge */
        .cache-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .cache-badge-icon {
            font-size: 14px;
        }

        .cache-note {
            background: #1d3a2d;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #8fdf9f;
        }

        .cache-similarity {
            font-size: 10px;
            opacity: 0.9;
            margin-left: 8px;
        }

        .cache-modifications {
            background: #1d3a2d;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .cache-mod-label {
            color: #8fdf9f;
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .cache-modifications ul {
            margin: 0;
            padding-left: 18px;
            color: #b8e6c1;
        }

        .cache-modifications li {
            margin-bottom: 2px;
        }

        /* Alternatives Grid */
        .alternatives-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .alternative-item {
            background: #2a2a3e;
            border: 1px solid #3a3a4e;
            border-radius: 8px;
            padding: 12px;
        }

        .alternative-header {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .alternative-query {
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            border: 1px solid #333;
            margin-bottom: 8px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Authentication Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .auth-container {
            background: #1e1e2e;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
        }

        .auth-title {
            color: #667eea;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
        }

        .auth-form-group {
            margin-bottom: 20px;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #999;
            font-size: 14px;
        }

        .auth-form-group input {
            width: 100%;
            padding: 12px;
            background: #2a2a3e;
            border: 1px solid #3a3a4e;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .auth-form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .auth-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-error {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 5px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #999;
            font-size: 14px;
        }

        .auth-switch a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .user-info-header {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #2a2a3e;
            padding: 10px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: #e0e0e0;
            font-weight: 600;
        }

        .admin-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .logout-btn {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* Context Wizard Modal */
        .context-wizard-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .context-wizard-overlay.show {
            display: flex;
        }

        .context-wizard {
            background: #1e1e2e;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .wizard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 20px 20px 0 0;
        }

        .wizard-header h2 {
            color: white;
            margin: 0;
            font-size: 18px;
        }

        .wizard-header p {
            color: rgba(255,255,255,0.8);
            margin: 8px 0 0 0;
            font-size: 13px;
        }

        .wizard-body {
            padding: 20px;
        }

        .wizard-section {
            margin-bottom: 20px;
        }

        .wizard-section-title {
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wizard-section-title .required {
            color: #dc3545;
            font-size: 12px;
        }

        .wizard-query-preview {
            background: #2a2a3e;
            padding: 12px;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 13px;
            border-left: 3px solid #667eea;
            margin-bottom: 20px;
        }

        .wizard-category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .wizard-category-btn {
            background: #2a2a3e;
            border: 2px solid #3a3a4e;
            color: #e0e0e0;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .wizard-category-btn:hover {
            border-color: #667eea;
        }

        .wizard-category-btn.selected {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .wizard-category-btn .icon {
            font-size: 20px;
            display: block;
            margin-bottom: 5px;
        }

        .wizard-category-btn .label {
            font-size: 12px;
            font-weight: 500;
        }

        .wizard-time-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .wizard-time-btn {
            background: #2a2a3e;
            border: 1px solid #3a3a4e;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .wizard-time-btn:hover {
            border-color: #667eea;
        }

        .wizard-time-btn.selected {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .wizard-questions {
            background: #3d3520;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
        }

        .wizard-questions-header {
            color: #ffc107;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wizard-question {
            margin-bottom: 12px;
        }

        .wizard-question:last-child {
            margin-bottom: 0;
        }

        .wizard-question label {
            display: block;
            color: #e0e0e0;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .wizard-question input,
        .wizard-question select {
            width: 100%;
            padding: 10px;
            background: #1a1a2e;
            border: 1px solid #3a3a4e;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 13px;
        }

        .wizard-question input:focus,
        .wizard-question select:focus {
            outline: none;
            border-color: #667eea;
        }

        .wizard-footer {
            padding: 15px 20px;
            border-top: 1px solid #3a3a4e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wizard-skip-btn {
            background: transparent;
            border: 1px solid #3a3a4e;
            color: #888;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .wizard-skip-btn:hover {
            border-color: #888;
            color: #e0e0e0;
        }

        .wizard-submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .wizard-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .wizard-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .wizard-confidence {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .wizard-confidence-bar {
            flex: 1;
            height: 6px;
            background: #3a3a4e;
            border-radius: 3px;
            overflow: hidden;
        }

        .wizard-confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .wizard-confidence-fill.low {
            background: #dc3545;
        }

        .wizard-confidence-fill.medium {
            background: #ffc107;
        }

        .wizard-confidence-fill.high {
            background: #28a745;
        }

        .wizard-confidence-label {
            font-size: 11px;
            color: #888;
            min-width: 80px;
        }

        .wizard-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .wizard-hint {
            background: #2a2a3e;
            color: #888;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }

        /* Data Availability Warnings */
        .wizard-data-warnings {
            background: #3d2020;
            border: 1px solid #dc3545;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .wizard-data-warnings-header {
            color: #dc3545;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wizard-data-warning {
            background: #2a1a1a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .wizard-data-warning:last-child {
            margin-bottom: 0;
        }

        .wizard-data-warning-title {
            color: #ff6b6b;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .wizard-data-warning-desc {
            color: #ccc;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .wizard-data-warning-suggestion {
            color: #4ade80;
            font-size: 11px;
            background: #1a2a1a;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #4ade80;
        }

        .wizard-data-info {
            background: #1a2a3e;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .wizard-data-info-header {
            color: #3b82f6;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .wizard-data-info-content {
            color: #94a3b8;
            font-size: 11px;
            line-height: 1.5;
        }
    </style>
    <script>
        // Auto-detect API URL based on environment
        // Native: http://localhost:8080, Docker: /api (nginx proxy)
        const API_URL = '';  // Use relative URLs
    </script>
    <script src="auth.js"></script>
</head>
<body>
    <!-- User Info Header -->
    <div id="user-info" class="user-info-header" style="display: none;"></div>

    <!-- Main App Container -->
    <div id="main-app" class="main-container">
        <!-- History Sidebar -->
        <div class="history-sidebar">
            <div class="history-header">
                üìú Query History
            </div>
            <div class="history-search">
                <input type="text" id="historySearch" placeholder="Search history..." oninput="filterHistory()">
            </div>
            <div class="history-list" id="historyList" style="flex: 1;">
                <p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">No history yet</p>
            </div>

            <!-- Mode Toggle (Query vs Learn) -->
            <div class="format-toggle" style="background: linear-gradient(135deg, #1a1a2e 0%, #252538 100%); border: 2px solid #667eea;">
                <span class="format-toggle-label" style="color: #667eea; font-weight: 600;">Mode:</span>
                <button class="format-toggle-btn active" id="modeQuery" onclick="setMode('query')" title="Generate Splunk queries">‚ö° Query</button>
                <button class="format-toggle-btn" id="modeLearn" onclick="setMode('learn')" title="Learn about SPL">üìö Learn</button>
            </div>

            <!-- Explanation Format Toggle -->
            <div class="format-toggle" id="explanationFormatToggle">
                <span class="format-toggle-label">Explanation:</span>
                <button class="format-toggle-btn active" id="formatStructured" onclick="setExplanationFormat('structured')">Structured</button>
                <button class="format-toggle-btn" id="formatParagraph" onclick="setExplanationFormat('paragraph')">Paragraph</button>
            </div>

            <!-- Index Selector -->
            <div class="index-selector">
                <div class="index-selector-header">
                    <span class="index-selector-label">üóÇÔ∏è Splunk Indexes</span>
                </div>
                <div class="index-tags" id="indexTags">
                    <!-- Index tags will be rendered here -->
                </div>
                <div class="index-input-row">
                    <input type="text" class="index-input" id="newIndexInput" placeholder="Add index..." onkeypress="handleIndexKeyPress(event)">
                    <button class="index-selector-add" onclick="addIndex()">+</button>
                </div>
            </div>
        </div>

        <!-- Main Chat -->
        <div class="container">
            <div class="header">
                <h1>‚ö° Zeus - Splunk Query Assistant</h1>
                <p>Ask me to generate Splunk queries in natural language</p>
            </div>

            <div class="chat-container" id="chatContainer">
                <!-- Initial welcome message - will be replaced by JS based on mode -->
                <div class="message assistant" data-mode="welcome">
                    <div class="message-content">
                        <p>Hi! I'm Zeus, your Splunk Query Assistant. I can help you generate SPL queries from natural language.</p>
                        <p style="margin-top: 10px;">Try asking me something like:</p>
                        <div class="examples">
                            <span class="example-chip" onclick="setInput('Find failed SSH login attempts in the last 24 hours')">Find failed SSH logins</span>
                            <span class="example-chip" onclick="setInput('Show me all firewall blocks')">Firewall blocks</span>
                            <span class="example-chip" onclick="setInput('Get Windows security events with Event ID 4624')">Windows security events</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <input
                        type="text"
                        id="userInput"
                        placeholder="Ask for a Splunk query..."
                        onkeypress="handleKeyPress(event)"
                    >
                    <button id="sendBtn" onclick="sendMessage()">Send</button>
                    <button id="stopBtn" class="stop-btn" onclick="stopGeneration()">Stop</button>
                </div>
                <div class="button-row">
                    <button id="generateAltBtn" onclick="generateAlternatives()">üîÑ Generate 3 Alternatives</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lastUserQuery = '';
        let currentAbortController = null;
        let explanationFormat = 'structured'; // 'structured' or 'paragraph'
        let currentMode = 'query'; // 'query' or 'learn'
        let historyData = []; // Store history for filtering
        let selectedIndexes = ['wazuh-alerts']; // Default index

        // Context Wizard State
        let wizardState = {
            instruction: '',
            selectedCategory: null,
            selectedTimeRange: '-24h',
            clarificationQuestions: [],
            contextAnswers: {},
            confidenceScore: 0
        };

        // Context Wizard Functions
        function openContextWizard(instruction) {
            wizardState.instruction = instruction;
            wizardState.selectedCategory = null;
            wizardState.contextAnswers = {};

            // Update query preview
            document.getElementById('wizard-query-preview').textContent = instruction;

            // Reset category selection
            document.querySelectorAll('.wizard-category-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Show wizard
            document.getElementById('context-wizard-overlay').classList.add('show');

            // Analyze context
            analyzeContext();
        }

        function closeContextWizard() {
            document.getElementById('context-wizard-overlay').classList.remove('show');
        }

        function selectCategory(category) {
            wizardState.selectedCategory = category;

            // Update UI
            document.querySelectorAll('.wizard-category-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.category === category);
            });

            // Re-analyze with new category
            analyzeContext();
        }

        function selectTimeRange(timeRange) {
            wizardState.selectedTimeRange = timeRange;

            // Update UI
            document.querySelectorAll('.wizard-time-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.time === timeRange);
            });

            // Re-analyze
            analyzeContext();
        }

        async function analyzeContext() {
            try {
                const response = await fetch(`${API_URL}/context/analyze`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        instruction: wizardState.instruction,
                        selected_indexes: selectedIndexes,
                        selected_category: wizardState.selectedCategory,
                        time_range: wizardState.selectedTimeRange
                    })
                });

                if (!response.ok) {
                    console.error('Context analysis failed');
                    return;
                }

                const data = await response.json();

                // Update confidence display
                wizardState.confidenceScore = data.confidence_score;
                updateConfidenceDisplay(data.confidence_score);

                // Auto-select detected category if none selected
                if (data.detected_category && !wizardState.selectedCategory) {
                    selectCategory(data.detected_category);
                }

                // Show clarification questions if needed
                if (data.needs_clarification && data.clarification_questions.length > 0) {
                    showClarificationQuestions(data.clarification_questions);
                } else {
                    hideClarificationQuestions();
                }

                // Show data availability warnings
                if (data.data_warnings && data.data_warnings.length > 0) {
                    showDataWarnings(data.data_warnings);
                } else {
                    showDataWarnings([]);
                }

                // Show data source info
                if (data.data_source_info) {
                    showDataSourceInfo(data.data_source_info);
                } else {
                    showDataSourceInfo(null);
                }

                // Show hints
                showContextHints(data.context_hints);

            } catch (error) {
                console.error('Error analyzing context:', error);
            }
        }

        function updateConfidenceDisplay(score) {
            const fill = document.getElementById('wizard-confidence-fill');
            const text = document.getElementById('wizard-confidence-text');

            const percentage = Math.round(score * 100);
            fill.style.width = percentage + '%';
            text.textContent = percentage + '%';

            // Update color class
            fill.classList.remove('low', 'medium', 'high');
            if (score < 0.4) {
                fill.classList.add('low');
            } else if (score < 0.7) {
                fill.classList.add('medium');
            } else {
                fill.classList.add('high');
            }
        }

        function showClarificationQuestions(questions) {
            wizardState.clarificationQuestions = questions;
            const section = document.getElementById('wizard-questions-section');
            const container = document.getElementById('wizard-questions-container');

            container.innerHTML = questions.map((q, i) => `
                <div class="wizard-question">
                    <label for="wizard-q-${i}">${escapeHtml(q)}</label>
                    <input type="text" id="wizard-q-${i}" placeholder="Your answer..."
                           onchange="updateContextAnswer(${i}, this.value)">
                </div>
            `).join('');

            section.style.display = 'block';
        }

        function hideClarificationQuestions() {
            document.getElementById('wizard-questions-section').style.display = 'none';
        }

        function updateContextAnswer(index, value) {
            const question = wizardState.clarificationQuestions[index];
            if (question) {
                wizardState.contextAnswers[question] = value;
            }
            // Re-analyze with new answers
            analyzeContext();
        }

        function showContextHints(hints) {
            const container = document.getElementById('wizard-hints');
            if (hints && hints.length > 0) {
                container.innerHTML = hints.map(h =>
                    `<span class="wizard-hint">${escapeHtml(h)}</span>`
                ).join('');
            } else {
                container.innerHTML = '';
            }
        }

        function showDataWarnings(warnings) {
            const section = document.getElementById('wizard-data-warnings-section');
            const container = document.getElementById('wizard-data-warnings-container');

            if (!warnings || warnings.length === 0) {
                section.style.display = 'none';
                return;
            }

            container.innerHTML = warnings.map(w => `
                <div class="wizard-data-warning">
                    <div class="wizard-data-warning-title">
                        ${w.severity === 'error' ? 'üö´' : '‚ö†Ô∏è'} ${escapeHtml(w.requested_capability)}
                    </div>
                    <div class="wizard-data-warning-desc">
                        ${escapeHtml(w.description)}
                    </div>
                    <div class="wizard-data-warning-suggestion">
                        <strong>üí° Suggestion:</strong> ${escapeHtml(w.suggestion)}
                    </div>
                </div>
            `).join('');

            section.style.display = 'block';
        }

        function showDataSourceInfo(info) {
            const section = document.getElementById('wizard-data-info-section');
            const content = document.getElementById('wizard-data-info-content');

            if (!info) {
                section.style.display = 'none';
                return;
            }

            content.textContent = info;
            section.style.display = 'block';
        }

        async function submitWithContext() {
            closeContextWizard();

            const input = document.getElementById('userInput');
            input.value = wizardState.instruction;

            // Add user message to chat
            addMessage(wizardState.instruction, 'user');
            lastUserQuery = wizardState.instruction;
            input.value = '';

            // Setup abort controller
            currentAbortController = new AbortController();

            // Show loading state
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            sendBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';

            try {
                // Use the new context-aware endpoint
                const response = await fetch(`${API_URL}/generate/with-context`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        instruction: wizardState.instruction,
                        input: '',
                        indexes: selectedIndexes,
                        log_category: wizardState.selectedCategory,
                        time_range: wizardState.selectedTimeRange,
                        temperature: 0.3,
                        max_new_tokens: 256,
                        explanation_format: explanationFormat,
                        context_answers: wizardState.contextAnswers
                    }),
                    signal: currentAbortController.signal
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const data = await response.json();

                // Prepare cache info
                const cacheInfo = data.from_cache ? {
                    from_cache: data.from_cache,
                    cache_similarity: data.cache_similarity,
                    cache_note: data.cache_note,
                    cache_params_modified: data.cache_params_modified,
                    cache_modifications: data.cache_modifications
                } : null;

                // Get data warnings from response
                const dataWarnings = data.data_warnings || [];

                // Add response with data warnings
                addMessage(data.query, 'assistant', data.is_clarification, false, data.explanation, cacheInfo, dataWarnings);

                // Reload history
                loadHistory();

            } catch (error) {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Error:', error);
                addMessage(`Error: ${error.message}. Please try again.`, 'assistant', false, true);
            } finally {
                currentAbortController = null;
                sendBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
        }

        // Index management functions
        function renderIndexTags() {
            const container = document.getElementById('indexTags');
            if (selectedIndexes.length === 0) {
                container.innerHTML = '<span style="font-size: 10px; color: #666;">No indexes selected (using defaults)</span>';
                return;
            }
            container.innerHTML = selectedIndexes.map(idx => `
                <span class="index-tag active">
                    ${escapeHtml(idx)}
                    <span class="index-tag-remove" onclick="removeIndex('${escapeHtml(idx)}')">&times;</span>
                </span>
            `).join('');
        }

        function addIndex() {
            const input = document.getElementById('newIndexInput');
            const indexName = input.value.trim().toLowerCase();
            if (indexName && !selectedIndexes.includes(indexName)) {
                selectedIndexes.push(indexName);
                renderIndexTags();
                saveIndexesToStorage();
            }
            input.value = '';
        }

        function removeIndex(indexName) {
            selectedIndexes = selectedIndexes.filter(idx => idx !== indexName);
            renderIndexTags();
            saveIndexesToStorage();
        }

        function handleIndexKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addIndex();
            }
        }

        function saveIndexesToStorage() {
            localStorage.setItem('zeus_selected_indexes', JSON.stringify(selectedIndexes));
        }

        function loadIndexesFromStorage() {
            const stored = localStorage.getItem('zeus_selected_indexes');
            if (stored) {
                try {
                    selectedIndexes = JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse stored indexes:', e);
                    selectedIndexes = ['wazuh-alerts'];
                }
            }
            renderIndexTags();
        }

        function getSelectedIndexes() {
            return selectedIndexes.length > 0 ? selectedIndexes : null;
        }

        // Explanation format toggle
        function setExplanationFormat(format) {
            explanationFormat = format;
            document.getElementById('formatStructured').classList.toggle('active', format === 'structured');
            document.getElementById('formatParagraph').classList.toggle('active', format === 'paragraph');
        }

        // Mode toggle (Query vs Learn)
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeQuery').classList.toggle('active', mode === 'query');
            document.getElementById('modeLearn').classList.toggle('active', mode === 'learn');

            // Update UI based on mode
            const userInput = document.getElementById('userInput');
            const header = document.querySelector('.header h1');
            const headerDesc = document.querySelector('.header p');
            const generateAltBtn = document.getElementById('generateAltBtn');
            const explanationToggle = document.getElementById('explanationFormatToggle');
            const indexSelector = document.querySelector('.index-selector');

            if (mode === 'learn') {
                userInput.placeholder = 'Ask about SPL commands, functions, or concepts...';
                header.innerHTML = 'üìö Zeus - SPL Academy';
                headerDesc.textContent = 'Learn about Splunk Processing Language';
                generateAltBtn.style.display = 'none';
                explanationToggle.style.display = 'none';
                indexSelector.style.display = 'none';
            } else {
                userInput.placeholder = 'Ask for a Splunk query...';
                header.innerHTML = '‚ö° Zeus - Splunk Query Assistant';
                headerDesc.textContent = 'Ask me to generate Splunk queries in natural language';
                generateAltBtn.style.display = 'inline-block';
                explanationToggle.style.display = 'flex';
                indexSelector.style.display = 'block';
            }

            // Filter messages to show only current mode's conversation
            filterMessagesByMode(mode);

            // Save to localStorage
            localStorage.setItem('zeus_mode', mode);
        }

        // Filter and show only messages for the current mode
        function filterMessagesByMode(mode) {
            const chatContainer = document.getElementById('chatContainer');
            const messages = chatContainer.querySelectorAll('.message');
            let hasMessagesForMode = false;

            messages.forEach(msg => {
                const msgMode = msg.dataset.mode;
                // Welcome messages (no mode) are always hidden when switching, we'll add a fresh one
                if (!msgMode || msgMode === 'welcome') {
                    msg.style.display = 'none';
                } else if (msgMode === mode) {
                    msg.style.display = 'flex';
                    hasMessagesForMode = true;
                } else {
                    msg.style.display = 'none';
                }
            });

            // Always show a welcome message for the current mode
            showWelcomeForMode(mode, !hasMessagesForMode);
        }

        // Show welcome message for current mode
        function showWelcomeForMode(mode, showExamples) {
            const chatContainer = document.getElementById('chatContainer');

            // Remove any existing welcome messages
            const existingWelcomes = chatContainer.querySelectorAll('.message[data-mode="welcome"]');
            existingWelcomes.forEach(w => w.remove());

            // Create welcome message for current mode
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'message assistant';
            welcomeDiv.dataset.mode = 'welcome';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (mode === 'learn') {
                contentDiv.innerHTML = `
                    <p>Hi! I'm Zeus in <strong>Learn Mode</strong>. I can help you understand Splunk Processing Language (SPL).</p>
                    ${showExamples ? `
                    <p style="margin-top: 10px;">Try asking me questions like:</p>
                    <div class="examples">
                        <span class="example-chip" onclick="setInput('What does the stats command do?')">stats command</span>
                        <span class="example-chip" onclick="setInput('How do I use the eval function?')">eval function</span>
                        <span class="example-chip" onclick="setInput('What\\'s the difference between stats and eventstats?')">stats vs eventstats</span>
                        <span class="example-chip" onclick="setInput('How do time ranges work in Splunk?')">time ranges</span>
                        <span class="example-chip" onclick="setInput('Best practices for search optimization')">best practices</span>
                    </div>
                    ` : ''}
                    <p style="margin-top: 15px; font-size: 12px; color: #888;">
                        üí° Tip: Switch to <strong>Query Mode</strong> when you want to generate actual Splunk queries.
                    </p>
                `;
            } else {
                contentDiv.innerHTML = `
                    <p>Hi! I'm Zeus, your Splunk Query Assistant. I can help you generate SPL queries from natural language.</p>
                    ${showExamples ? `
                    <p style="margin-top: 10px;">Try asking me something like:</p>
                    <div class="examples">
                        <span class="example-chip" onclick="setInput('Find failed SSH login attempts in the last 24 hours')">Find failed SSH logins</span>
                        <span class="example-chip" onclick="setInput('Show me all firewall blocks')">Firewall blocks</span>
                        <span class="example-chip" onclick="setInput('Get Windows security events with Event ID 4624')">Windows security events</span>
                    </div>
                    ` : ''}
                    <p style="margin-top: 15px; font-size: 12px; color: #888;">
                        üí° Tip: Switch to <strong>Learn Mode</strong> to learn about SPL commands and functions.
                    </p>
                `;
            }

            welcomeDiv.appendChild(contentDiv);
            // Insert at the beginning
            chatContainer.insertBefore(welcomeDiv, chatContainer.firstChild);
        }

        // Load saved mode on init
        function loadSavedMode() {
            const savedMode = localStorage.getItem('zeus_mode') || 'query';
            setMode(savedMode);
        }

        // Stop generation
        function stopGeneration() {
            if (currentAbortController) {
                currentAbortController.abort();
                currentAbortController = null;
            }
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            sendBtn.disabled = false;
            sendBtn.innerHTML = 'Send';
            sendBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            addMessage('Query generation stopped by user.', 'assistant', false, true);
        }

        async function loadHistory() {
            const historyList = document.getElementById('historyList');

            // Check if user is authenticated
            if (!isAuthenticated()) {
                historyList.innerHTML = '<p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">Login to view history</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/queries/history?page=1&page_size=100`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch history');
                }

                const data = await response.json();
                historyData = data.queries; // Store for filtering

                renderHistory(historyData);

            } catch (error) {
                console.error('Error loading history:', error);
                historyList.innerHTML = '<p style="text-align: center; color: #dc3545; font-size: 12px; margin-top: 20px;">Error loading history</p>';
            }
        }

        function renderHistory(queries) {
            const historyList = document.getElementById('historyList');

            if (queries.length === 0) {
                const searchTerm = document.getElementById('historySearch')?.value;
                if (searchTerm) {
                    historyList.innerHTML = '<p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">No matching queries found</p>';
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">No history yet</p>';
                }
                return;
            }

            historyList.innerHTML = queries.map((item, index) => {
                const date = new Date(item.created_at);
                const timeStr = date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const feedbackBadge = item.has_feedback
                    ? `<span style="font-size: 10px; color: ${item.feedback_rating === 'good' ? '#28a745' : '#dc3545'};">${item.feedback_rating === 'good' ? 'üëç' : 'üëé'}</span>`
                    : '';

                // Create unique ID for this history item
                const historyId = `history-${item.id}`;

                return `
                    <div class="history-item" style="cursor: pointer;" onclick="toggleHistoryQuery('${historyId}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500; margin-bottom: 2px;">
                                    ${escapeHtml(item.instruction.substring(0, 60))}${item.instruction.length > 60 ? '...' : ''}
                                </div>
                                <div class="history-item-time">${timeStr} ${feedbackBadge}</div>
                            </div>
                            <span style="font-size: 12px; color: #667eea;">‚ñº</span>
                        </div>
                        <div id="${historyId}" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #3a3a4e;">
                            <div style="font-size: 11px; color: #999; margin-bottom: 5px;">Generated Query:</div>
                            <pre style="background: #1a1a2e; padding: 8px; border-radius: 5px; font-size: 11px; overflow-x: auto; margin: 0;">${escapeHtml(item.generated_query)}</pre>
                            <button onclick="event.stopPropagation(); copyToClipboard('${escapeHtml(item.generated_query).replace(/'/g, "\\'")}', this)" style="margin-top: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy Query</button>
                            <button onclick="event.stopPropagation(); setInput('${escapeHtml(item.instruction).replace(/'/g, "\\'")}'); document.getElementById('${historyId}').style.display = 'none';" style="margin-top: 8px; margin-left: 5px; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Rerun</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase().trim();

            if (!searchTerm) {
                renderHistory(historyData);
                return;
            }

            const filtered = historyData.filter(item => {
                return item.instruction.toLowerCase().includes(searchTerm) ||
                       item.generated_query.toLowerCase().includes(searchTerm);
            });

            renderHistory(filtered);
        }

        function setInput(text) {
            document.getElementById('userInput').value = text;
            document.getElementById('userInput').focus();
        }

        function toggleHistoryQuery(historyId) {
            const element = document.getElementById(historyId);
            if (element.style.display === 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }

        function copyToClipboard(text, btnElement) {
            // Try modern clipboard API first, fall back to execCommand
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccessHistory(btnElement);
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopyText(text, btnElement);
                });
            } else {
                fallbackCopyText(text, btnElement);
            }
        }

        function fallbackCopyText(text, btnElement) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccessHistory(btnElement);
                } else {
                    alert('Failed to copy query');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Failed to copy query');
            }

            document.body.removeChild(textArea);
        }

        function showCopySuccessHistory(btnElement) {
            const originalText = btnElement.textContent;
            btnElement.textContent = '‚úì Copied!';
            btnElement.style.background = '#218838';
            setTimeout(() => {
                btnElement.textContent = originalText;
                btnElement.style.background = '#667eea';
            }, 2000);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();

            if (!message) return;

            // Handle differently based on mode
            if (currentMode === 'learn') {
                // Learn mode: Send to /learn endpoint directly
                sendLearnMessage(message);
            } else {
                // Query mode: Open context wizard to gather context before generating
                openContextWizard(message);
            }
        }

        // Send message in Learn Mode
        async function sendLearnMessage(message) {
            const input = document.getElementById('userInput');

            lastUserQuery = message;

            // Add user message
            addMessage(message, 'user');
            input.value = '';

            // Setup abort controller for stop functionality
            currentAbortController = new AbortController();

            // Show loading state
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            sendBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';

            try {
                const response = await fetch(`/api/learn`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        question: message
                    }),
                    signal: currentAbortController.signal
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const data = await response.json();

                // Add assistant response with learning content
                addLearnMessage(data);

            } catch (error) {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Error:', error);
                addMessage(`Error: ${error.message}. Please check your connection and try again.`, 'assistant', false, true);
            } finally {
                currentAbortController = null;
                sendBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
        }

        // Add learning response message
        function addLearnMessage(data) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.dataset.mode = 'learn';  // Tag as learn mode message

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.style.maxWidth = '85%';

            // Convert markdown-like formatting to HTML
            let formattedAnswer = formatLearnAnswer(data.answer);

            // Build related topics section
            let relatedHtml = '';
            if (data.related_topics && data.related_topics.length > 0) {
                relatedHtml = `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #3a3a4e;">
                        <span style="font-size: 12px; color: #667eea; font-weight: 600;">Related Topics:</span>
                        <div style="margin-top: 8px;">
                            ${data.related_topics.map(topic =>
                                `<span class="example-chip" onclick="setInput('Tell me about ${escapeHtml(topic)}')">${escapeHtml(topic)}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            contentDiv.innerHTML = `
                <div class="learn-response">
                    ${formattedAnswer}
                    ${relatedHtml}
                </div>
            `;

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Format learning answer (markdown-like to HTML)
        function formatLearnAnswer(text) {
            let html = escapeHtml(text);

            // Convert markdown code blocks
            html = html.replace(/```spl\n?([\s\S]*?)```/g, '<pre class="query-code">$1</pre>');
            html = html.replace(/```\n?([\s\S]*?)```/g, '<pre class="query-code">$1</pre>');

            // Convert inline code
            html = html.replace(/`([^`]+)`/g, '<code style="background: #1a1a2e; padding: 2px 6px; border-radius: 4px; color: #00ff00;">$1</code>');

            // Convert headers
            html = html.replace(/^## (.+)$/gm, '<h3 style="color: #667eea; margin-top: 15px; margin-bottom: 10px;">$1</h3>');
            html = html.replace(/^### (.+)$/gm, '<h4 style="color: #888; margin-top: 12px; margin-bottom: 8px; font-size: 13px; text-transform: uppercase;">$1</h4>');

            // Convert bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Convert bullet lists
            html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul style="margin: 8px 0; padding-left: 20px;">$&</ul>');

            // Convert line breaks
            html = html.replace(/\n\n/g, '</p><p style="margin-top: 10px;">');
            html = '<p>' + html + '</p>';

            return html;
        }

        // Legacy direct send (used for high-confidence queries or after wizard)
        async function sendMessageDirect() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();

            if (!message) return;

            lastUserQuery = message;

            // Add user message
            addMessage(message, 'user');
            input.value = '';

            // Setup abort controller for stop functionality
            currentAbortController = new AbortController();

            // Show stop button, hide send button
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            sendBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';

            try {
                const response = await fetch(`${API_URL}/generate`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        instruction: message,
                        input: '',
                        temperature: 0.3,
                        max_new_tokens: 256,
                        repetition_penalty: 1.2,
                        explanation_format: explanationFormat,
                        indexes: getSelectedIndexes()
                    }),
                    signal: currentAbortController.signal
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const data = await response.json();

                // Prepare cache info if available
                const cacheInfo = data.from_cache ? {
                    from_cache: data.from_cache,
                    cache_similarity: data.cache_similarity,
                    cache_note: data.cache_note,
                    cache_params_modified: data.cache_params_modified,
                    cache_modifications: data.cache_modifications
                } : null;

                // Get data warnings from response
                const dataWarnings = data.data_warnings || [];

                // Add assistant response with explanation, cache info, and data warnings
                addMessage(data.query, 'assistant', data.is_clarification, false, data.explanation, cacheInfo, dataWarnings);

                // Reload history to show the new query
                loadHistory();

            } catch (error) {
                if (error.name === 'AbortError') {
                    // User cancelled - message already shown by stopGeneration()
                    return;
                }
                console.error('Error:', error);
                addMessage(`Error: ${error.message}. Please check your connection and try again.`, 'assistant', false, true);
            } finally {
                currentAbortController = null;
                sendBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
        }

        async function generateAlternatives() {
            const input = document.getElementById('userInput');
            const message = input.value.trim() || lastUserQuery;

            if (!message) {
                alert('Please enter a query first, or use your last query');
                return;
            }

            // Add user message if new
            if (input.value.trim()) {
                lastUserQuery = message;
                addToHistory(message);
                addMessage(message, 'user');
                input.value = '';
            }

            const altBtn = document.getElementById('generateAltBtn');
            altBtn.disabled = true;
            altBtn.innerHTML = '<div class="loading"></div>';

            try {
                // Generate 3 alternatives with different temperatures
                const indexes = getSelectedIndexes();
                const promises = [
                    fetch(`${API_URL}/generate`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            instruction: message,
                            input: '',
                            temperature: 0.2,
                            max_new_tokens: 256,
                            repetition_penalty: 1.2,
                            indexes: indexes
                        })
                    }),
                    fetch(`${API_URL}/generate`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            instruction: message,
                            input: '',
                            temperature: 0.5,
                            max_new_tokens: 256,
                            repetition_penalty: 1.2,
                            indexes: indexes
                        })
                    }),
                    fetch(`${API_URL}/generate`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            instruction: message,
                            input: '',
                            temperature: 0.8,
                            max_new_tokens: 256,
                            repetition_penalty: 1.2,
                            indexes: indexes
                        })
                    })
                ];

                const responses = await Promise.all(promises);
                const data = await Promise.all(responses.map(r => r.json()));

                // Add alternatives as a special message
                addAlternatives(data);

            } catch (error) {
                console.error('Error:', error);
                addMessage(`Error: ${error.message}. Make sure the API server is running.`, 'assistant', false, true);
            } finally {
                altBtn.disabled = false;
                altBtn.innerHTML = 'üîÑ Generate 3 Alternatives';
            }
        }

        function addAlternatives(dataArray) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.dataset.mode = 'query';  // Alternatives are query mode only

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.style.maxWidth = '90%';

            contentDiv.innerHTML = `
                <p><strong>üîÑ Generated 3 Alternative Queries:</strong></p>
                <div class="alternatives-container">
                    ${dataArray.map((data, i) => `
                        <div class="alternative-item">
                            <div class="alternative-header">Option ${i + 1} ${i === 0 ? '(Conservative)' : i === 1 ? '(Balanced)' : '(Creative)'}</div>
                            <div class="alternative-query" id="alt-query-${i}">${escapeHtml(data.query)}</div>
                            <button class="copy-btn" onclick="copyQueryOnly('alt-query-${i}', this)">Copy Query</button>
                        </div>
                    `).join('')}
                </div>
            `;

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addMessage(text, sender, isClarification = false, isError = false, explanation = null, cacheInfo = null, dataWarnings = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.dataset.mode = currentMode;  // Tag message with current mode

            const contentDiv = document.createElement('div');
            contentDiv.className = `message-content ${isClarification ? 'clarification' : ''}`;

            if (sender === 'assistant' && !isError) {
                if (isClarification) {
                    contentDiv.innerHTML = `
                        <span class="clarification-tag">CLARIFICATION REQUEST</span>
                        <p>${escapeHtml(text)}</p>
                    `;
                } else {
                    const queryId = 'query-' + Date.now();
                    const feedbackId = 'feedback-' + Date.now();
                    const explanationId = 'explanation-' + Date.now();

                    // Data availability warnings
                    let dataWarningsHtml = '';
                    if (dataWarnings && dataWarnings.length > 0) {
                        const warningItems = dataWarnings.map(w => `
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #ff6b6b;">‚ö†Ô∏è ${escapeHtml(w.capability || w.requested_capability)}</strong>
                                <p style="margin: 4px 0; font-size: 12px; color: #ccc;">${escapeHtml(w.description || w.requested_description || '')}</p>
                                <p style="margin: 4px 0; font-size: 11px; color: #4ade80;">üí° ${escapeHtml(w.suggestion)}</p>
                            </div>
                        `).join('');
                        dataWarningsHtml = `
                            <div style="background: #3d2020; border: 1px solid #dc3545; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                <div style="color: #dc3545; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Data Availability Warning</div>
                                ${warningItems}
                            </div>
                        `;
                    }

                    // Cache badge if result came from approved query cache
                    let cacheHtml = '';
                    if (cacheInfo && cacheInfo.from_cache) {
                        const similarityPercent = Math.round((cacheInfo.cache_similarity || 0) * 100);
                        let badgeText = 'Approved Query Match';
                        if (cacheInfo.cache_params_modified) {
                            badgeText = 'Approved Query (Adjusted)';
                        }

                        // Build modifications list if any
                        let modificationsHtml = '';
                        if (cacheInfo.cache_modifications && cacheInfo.cache_modifications.length > 0) {
                            modificationsHtml = `
                                <div class="cache-modifications">
                                    <span class="cache-mod-label">Adjustments made:</span>
                                    <ul>${cacheInfo.cache_modifications.map(m => `<li>${escapeHtml(m)}</li>`).join('')}</ul>
                                </div>
                            `;
                        }

                        cacheHtml = `
                            <div class="cache-badge">
                                <span class="cache-badge-icon">${cacheInfo.cache_params_modified ? '‚ö°' : '‚úì'}</span>
                                <span>${badgeText}</span>
                                <span class="cache-similarity">${similarityPercent}% similar</span>
                            </div>
                            ${modificationsHtml}
                        `;
                    }

                    let explanationHtml = '';
                    if (explanation) {
                        explanationHtml = `
                            <div class="explanation-section" id="${explanationId}">
                                <div class="explanation-header">
                                    <span>üí°</span>
                                    <span>Query Explanation</span>
                                </div>
                                <div class="explanation-text">${formatExplanation(explanation)}</div>
                            </div>
                        `;
                    }

                    contentDiv.innerHTML = `
                        ${dataWarningsHtml}
                        ${cacheHtml}
                        <p><strong>${cacheInfo && cacheInfo.from_cache ? 'Previously Approved Query:' : 'Generated Splunk Query:'}</strong></p>
                        <div class="query-code" id="${queryId}">${escapeHtml(text)}</div>
                        <button class="copy-btn" onclick="copyQueryOnly('${queryId}', this)">Copy Query</button>
                        ${explanationHtml}
                        <div class="feedback-container" id="${feedbackId}" data-instruction="${escapeHtml(lastUserQuery)}" data-query-id="${queryId}">
                            <span style="font-size: 12px; color: #888;">Was this helpful?</span>
                            <button class="feedback-btn good" onclick="handleFeedback('${feedbackId}', 'good', this)" title="Good query">üëç</button>
                            <button class="feedback-btn bad" onclick="handleFeedback('${feedbackId}', 'bad', this)" title="Needs improvement">üëé</button>
                        </div>
                    `;
                }
            } else {
                contentDiv.textContent = text;
            }

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatExplanation(text) {
            // Escape HTML first
            let html = escapeHtml(text);

            // Split into lines
            const lines = html.split('\n');
            let result = [];
            let inList = false;
            let summary = [];
            let foundSection = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                // Check for section headers (### Input: or ### Output:)
                if (line.match(/^###?\s*(Input|Output):/i)) {
                    // Close any open list
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    // Add summary if we have it and this is first section
                    if (!foundSection && summary.length > 0) {
                        result.push(`<div class="summary">${summary.join(' ')}</div>`);
                    }
                    foundSection = true;

                    const sectionName = line.replace(/^###?\s*/i, '').replace(/:.*$/, '');
                    result.push(`<div class="section-header">${sectionName}</div>`);
                    result.push('<ul>');
                    inList = true;
                }
                // Check for bullet points
                else if (line.startsWith('-') || line.startsWith('‚Ä¢')) {
                    if (!inList) {
                        result.push('<ul>');
                        inList = true;
                    }
                    const bulletContent = line.replace(/^[-‚Ä¢]\s*/, '');
                    result.push(`<li>${bulletContent}</li>`);
                }
                // Regular text - either summary or continuation
                else if (line.length > 0) {
                    if (!foundSection) {
                        summary.push(line);
                    } else if (inList) {
                        // Continuation of previous bullet point or loose text
                        result.push(`<li>${line}</li>`);
                    }
                }
            }

            // Close any open list
            if (inList) {
                result.push('</ul>');
            }

            // If no sections were found, just return the escaped text with summary styling
            if (!foundSection) {
                return `<div class="summary">${summary.join('<br>')}</div>`;
            }

            return result.join('\n');
        }

        function copyQueryOnly(elementId, btnElement) {
            const element = document.getElementById(elementId);
            const text = element.textContent;

            // Try modern clipboard API first, fall back to execCommand
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(btnElement);
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopy(text, btnElement);
                });
            } else {
                fallbackCopy(text, btnElement);
            }
        }

        function fallbackCopy(text, btnElement) {
            // Create temporary textarea for copying
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(btnElement);
                } else {
                    alert('Failed to copy query');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Failed to copy query');
            }

            document.body.removeChild(textArea);
        }

        function showCopySuccess(btnElement) {
            const originalText = btnElement.textContent;
            btnElement.textContent = '‚úì Copied!';
            btnElement.style.background = '#218838';
            setTimeout(() => {
                btnElement.textContent = originalText;
                btnElement.style.background = '#28a745';
            }, 2000);
        }

        function handleFeedback(feedbackId, rating, btnElement) {
            console.log('handleFeedback called:', feedbackId, rating);
            const feedbackContainer = document.getElementById(feedbackId);

            // Get instruction and query from data attributes
            const instruction = feedbackContainer.getAttribute('data-instruction');
            const generatedQuery = feedbackContainer.getAttribute('data-query');
            console.log('Instruction:', instruction, 'Query:', generatedQuery);

            // Check if this is the currently selected rating
            const currentRating = feedbackContainer.getAttribute('data-current-rating');
            console.log('Current rating:', currentRating, 'New rating:', rating);

            if (currentRating === rating) {
                // Already selected this rating, do nothing
                console.log('Same rating clicked, ignoring');
                return;
            }

            // Update the current rating
            feedbackContainer.setAttribute('data-current-rating', rating);
            console.log('Updated current rating to:', rating);

            // Mark button as selected and grey out the other button
            const allButtons = feedbackContainer.querySelectorAll('.feedback-btn');
            allButtons.forEach(btn => {
                btn.classList.remove('selected', 'disabled');
                if (btn !== btnElement) {
                    btn.classList.add('disabled');
                }
            });
            btnElement.classList.add('selected');

            // Remove any existing correction UI and status messages
            const existingCorrection = feedbackContainer.querySelector('.correction-ui');
            if (existingCorrection) {
                existingCorrection.remove();
            }
            const existingStatus = feedbackContainer.querySelectorAll('.feedback-status');
            existingStatus.forEach(status => status.remove());

            // If rating is bad, show correction input
            if (rating === 'bad') {
                const correctionUI = document.createElement('div');
                correctionUI.className = 'correction-ui';
                correctionUI.style.width = '100%';
                correctionUI.style.marginTop = '8px';
                correctionUI.innerHTML = `
                    <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">
                        Provide the correct query (optional):
                    </label>
                    <textarea class="correction-input" id="correction-${feedbackId}" rows="3" placeholder="Enter the correct Splunk query..."></textarea>
                    <button class="submit-feedback-btn" onclick="submitFeedback('${feedbackId}', '${rating}')">
                        Submit Feedback
                    </button>
                    <div id="status-${feedbackId}" class="feedback-status"></div>
                `;
                feedbackContainer.appendChild(correctionUI);
            } else {
                // For good rating, submit immediately
                submitFeedback(feedbackId, rating);
            }
        }

        async function submitFeedback(feedbackId, rating) {
            const feedbackContainer = document.getElementById(feedbackId);
            const instruction = feedbackContainer.getAttribute('data-instruction');
            const queryId = feedbackContainer.getAttribute('data-query-id');
            const queryElement = document.getElementById(queryId);
            const generatedQuery = queryElement ? queryElement.textContent : '';

            const correctionInput = document.getElementById(`correction-${feedbackId}`);
            const statusDiv = document.getElementById(`status-${feedbackId}`);
            const correctedQuery = correctionInput ? correctionInput.value.trim() : null;

            try {
                const response = await fetch(`${API_URL}/feedback`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        instruction: instruction,
                        generated_query: generatedQuery,
                        rating: rating,
                        corrected_query: correctedQuery || null,
                        comment: null
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const data = await response.json();

                // Show success message
                if (statusDiv) {
                    statusDiv.textContent = '‚úì ' + data.message;
                    statusDiv.style.display = 'block';
                } else {
                    // For good rating (no status div yet)
                    const feedbackContainer = document.getElementById(feedbackId);
                    const status = document.createElement('div');
                    status.className = 'feedback-status';
                    status.textContent = '‚úì Thank you for your feedback!';
                    feedbackContainer.appendChild(status);
                }

                console.log('Feedback submitted successfully');

            } catch (error) {
                console.error('Error submitting feedback:', error);
                const msg = rating === 'good'
                    ? 'Error submitting feedback. Please try again.'
                    : 'Error submitting feedback. Please try again.';

                if (statusDiv) {
                    statusDiv.textContent = '‚úó ' + msg;
                    statusDiv.style.color = '#dc3545';
                } else {
                    alert(msg);
                }
            }
        }

        // Check API health on load
        window.onload = async () => {
            loadHistory();

            try {
                const response = await fetch('/api/health');
                if (!response.ok) {
                    throw new Error('API not responding');
                }
                const data = await response.json();
                if (!data.model_loaded) {
                    addMessage('Warning: Model is not loaded on the server. Please start the server with the model.', 'assistant', false, true);
                }
            } catch (error) {
                console.error('Health check failed:', error);
                // Only show warning if we can't reach the API at all
                // Don't show if it's just a JSON parse error from nginx health endpoint
            }
        };

        // Initialize authentication and settings on page load
        window.addEventListener('DOMContentLoaded', () => {
            initAuth();
            loadIndexesFromStorage();
            loadSavedMode();
        });
    </script>

    <!-- Context Wizard Modal -->
    <div id="context-wizard-overlay" class="context-wizard-overlay">
        <div class="context-wizard">
            <div class="wizard-header">
                <h2>Help Zeus Understand Your Query</h2>
                <p>Provide some context so Zeus can generate a more accurate query</p>
            </div>
            <div class="wizard-body">
                <!-- Query Preview -->
                <div class="wizard-query-preview" id="wizard-query-preview">
                    Your query will appear here...
                </div>

                <!-- Confidence Score -->
                <div class="wizard-confidence">
                    <span class="wizard-confidence-label">Confidence:</span>
                    <div class="wizard-confidence-bar">
                        <div class="wizard-confidence-fill low" id="wizard-confidence-fill" style="width: 20%"></div>
                    </div>
                    <span id="wizard-confidence-text" style="font-size: 11px; color: #888;">20%</span>
                </div>

                <!-- Log Category Selection -->
                <div class="wizard-section">
                    <div class="wizard-section-title">
                        What type of logs are you looking for?
                    </div>
                    <div class="wizard-category-grid" id="wizard-categories">
                        <button class="wizard-category-btn" data-category="authentication" onclick="selectCategory('authentication')">
                            <span class="icon">üîê</span>
                            <span class="label">Authentication</span>
                        </button>
                        <button class="wizard-category-btn" data-category="network" onclick="selectCategory('network')">
                            <span class="icon">üåê</span>
                            <span class="label">Network</span>
                        </button>
                        <button class="wizard-category-btn" data-category="process" onclick="selectCategory('process')">
                            <span class="icon">‚öôÔ∏è</span>
                            <span class="label">Process/Commands</span>
                        </button>
                        <button class="wizard-category-btn" data-category="file" onclick="selectCategory('file')">
                            <span class="icon">üìÅ</span>
                            <span class="label">File Activity</span>
                        </button>
                        <button class="wizard-category-btn" data-category="malware" onclick="selectCategory('malware')">
                            <span class="icon">ü¶†</span>
                            <span class="label">Malware/Threats</span>
                        </button>
                        <button class="wizard-category-btn" data-category="web" onclick="selectCategory('web')">
                            <span class="icon">üåç</span>
                            <span class="label">Web Traffic</span>
                        </button>
                        <button class="wizard-category-btn" data-category="system" onclick="selectCategory('system')">
                            <span class="icon">üíª</span>
                            <span class="label">System Events</span>
                        </button>
                        <button class="wizard-category-btn" data-category="compliance" onclick="selectCategory('compliance')">
                            <span class="icon">‚úÖ</span>
                            <span class="label">Compliance</span>
                        </button>
                    </div>
                </div>

                <!-- Time Range Selection -->
                <div class="wizard-section">
                    <div class="wizard-section-title">
                        Time Range
                    </div>
                    <div class="wizard-time-options">
                        <button class="wizard-time-btn" data-time="-1h" onclick="selectTimeRange('-1h')">Last Hour</button>
                        <button class="wizard-time-btn selected" data-time="-24h" onclick="selectTimeRange('-24h')">Last 24h</button>
                        <button class="wizard-time-btn" data-time="-7d" onclick="selectTimeRange('-7d')">Last 7 Days</button>
                        <button class="wizard-time-btn" data-time="-30d" onclick="selectTimeRange('-30d')">Last 30 Days</button>
                        <button class="wizard-time-btn" data-time="-90d" onclick="selectTimeRange('-90d')">Last 90 Days</button>
                        <button class="wizard-time-btn" data-time="-1y" onclick="selectTimeRange('-1y')">Last Year</button>
                    </div>
                </div>

                <!-- Data Availability Warnings (populated dynamically) -->
                <div id="wizard-data-warnings-section" style="display: none;">
                    <div class="wizard-data-warnings">
                        <div class="wizard-data-warnings-header">
                            <span>‚ö†Ô∏è</span>
                            <span>Data Availability Warning</span>
                        </div>
                        <div id="wizard-data-warnings-container">
                            <!-- Warnings will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Data Source Info -->
                <div id="wizard-data-info-section" style="display: none;">
                    <div class="wizard-data-info">
                        <div class="wizard-data-info-header">Your Selected Data Sources</div>
                        <div class="wizard-data-info-content" id="wizard-data-info-content">
                            <!-- Data source info will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Clarifying Questions (populated dynamically) -->
                <div class="wizard-section" id="wizard-questions-section" style="display: none;">
                    <div class="wizard-questions">
                        <div class="wizard-questions-header">
                            <span>‚ùì</span>
                            <span>Please answer these questions for a better query:</span>
                        </div>
                        <div id="wizard-questions-container">
                            <!-- Questions will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Context Hints -->
                <div class="wizard-hints" id="wizard-hints">
                    <!-- Hints will be inserted here -->
                </div>
            </div>
            <div class="wizard-footer">
                <button class="wizard-skip-btn" onclick="closeContextWizard()">Cancel</button>
                <button class="wizard-submit-btn" id="wizard-submit-btn" onclick="submitWithContext()">
                    Generate Query
                </button>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="auth-modal">
        <div class="auth-container">
            <!-- Login Form -->
            <div id="login-form-container">
                <h2 class="auth-title">Login to Zeus</h2>
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="auth-form-group">
                        <label for="login-username">Username</label>
                        <input type="text" id="login-username" required>
                    </div>
                    <div class="auth-form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="auth-submit">Login</button>
                    <div id="login-error" class="auth-error"></div>
                </form>
                <div class="auth-switch">
                    Don't have an account? <a onclick="switchToRegister()">Register</a>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-form-container" style="display: none;">
                <h2 class="auth-title">Create Account</h2>
                <form id="register-form" onsubmit="handleRegister(event)">
                    <div class="auth-form-group">
                        <label for="register-username">Username</label>
                        <input type="text" id="register-username" required minlength="3">
                    </div>
                    <div class="auth-form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="auth-form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" required minlength="6">
                    </div>
                    <div class="auth-form-group">
                        <label for="register-fullname">Full Name (Optional)</label>
                        <input type="text" id="register-fullname">
                    </div>
                    <button type="submit" class="auth-submit">Create Account</button>
                    <div id="register-error" class="auth-error"></div>
                </form>
                <div class="auth-switch">
                    Already have an account? <a onclick="switchToLogin()">Login</a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
