{"instruction": "Find failed logins followed by successful login from different IP", "input": "", "output": "index=* (action=failed OR action=failure) | stats earliest(_time) as first_fail, values(src_ip) as fail_ips by user | join user [search index=* action=success | stats latest(_time) as success_time, values(src_ip) as success_ips by user] | where success_time > first_fail | eval different_ip=if(fail_ips!=success_ips, \"Yes\", \"No\") | where different_ip=\"Yes\""}
{"instruction": "Correlate VPN connections with database access", "input": "", "output": "index=vpn action=connect | stats earliest(_time) as vpn_time by user, src_ip | join user [search index=database | stats latest(_time) as db_time by user] | where db_time > vpn_time AND db_time < (vpn_time + 3600)"}
{"instruction": "Find users accessing systems they've never accessed before", "input": "Baseline: last 90 days, Detection: last 24 hours", "output": "index=* earliest=-24h latest=now user=* dest=* | stats count by user, dest | join user dest type=left [search index=* earliest=-90d latest=-24h user=* dest=* | stats count as historical_count by user, dest] | where isnull(historical_count)"}
{"instruction": "Identify accounts with privileges not matching their department", "input": "Using lookup table: user_departments.csv", "output": "index=windows EventCode=4672 | lookup user_departments.csv user OUTPUT department, expected_privileges | where Privileges!=expected_privileges | table user, department, Privileges, expected_privileges"}
{"instruction": "Detect data transfer to new destinations", "input": "", "output": "index=network earliest=-1h bytes_out>1000000 | stats sum(bytes_out) as recent_bytes by dest_ip | join dest_ip type=left [search index=network earliest=-30d latest=-1h | stats count as historical_count by dest_ip] | where isnull(historical_count) | eval bytes_mb=round(recent_bytes/1048576, 2)"}
{"instruction": "Find processes spawned by web server executing unusual commands", "input": "", "output": "index=windows EventCode=4688 | rex field=Process_Command_Line \"(?<command>^\\S+)\" | search Parent_Process_Name=\"*w3wp.exe\" OR Parent_Process_Name=\"*httpd.exe\" OR Parent_Process_Name=\"*nginx.exe\" | where NOT match(command, \"(?i)(iisexpress|aspnet)\")"}
{"instruction": "Correlate endpoint alerts with network traffic", "input": "", "output": "index=edr alert_severity=high | eval alert_time=_time | join host [search index=network | eval network_time=_time] | where network_time > (alert_time - 300) AND network_time < (alert_time + 300) | stats values(dest_ip) as contacted_ips, values(dest_port) as contacted_ports by host, alert_name"}
{"instruction": "Identify privilege escalation followed by lateral movement", "input": "", "output": "index=windows EventCode=4672 Privileges=\"*SeDebugPrivilege*\" | eval escalation_time=_time | stats earliest(escalation_time) as esc_time by user | join user [search index=windows EventCode=4624 Logon_Type=3 | stats count dc(dest) as unique_systems earliest(_time) as first_lateral by user] | where first_lateral > esc_time AND first_lateral < (esc_time + 3600) AND unique_systems > 3"}
{"instruction": "Find suspicious file executions from temp directories with network activity", "input": "", "output": "index=windows EventCode=4688 (Process_Name=\"*\\Temp\\*\" OR Process_Name=\"*\\AppData\\Local\\Temp\\*\") | eval process_time=_time | join host [search index=network direction=outbound | eval network_time=_time] | where network_time > process_time AND network_time < (process_time + 60) | table host, user, Process_Name, dest_ip, dest_port"}
{"instruction": "Detect anomalous authentication times compared to user baseline", "input": "", "output": "index=* authentication action=success earliest=-24h | eval hour=strftime(_time, \"%H\") | join user [search index=* authentication action=success earliest=-30d latest=-1d | eval baseline_hour=strftime(_time, \"%H\") | stats values(baseline_hour) as normal_hours by user] | where NOT match(normal_hours, hour)"}
{"instruction": "Find commands executed within 5 minutes of opening a phishing email", "input": "", "output": "index=email subject=\"*urgent*\" OR subject=\"*invoice*\" attachment=*.exe | eval email_time=_time | join user [search index=windows EventCode=4688 | eval exec_time=_time] | where exec_time > email_time AND exec_time < (email_time + 300) | table user, subject, attachment, Process_Name, Process_Command_Line"}
{"instruction": "Correlate failed firewall rules with subsequent successful connections", "input": "", "output": "index=firewall action=blocked | stats earliest(_time) as block_time by src_ip, dest_ip, dest_port | join src_ip dest_ip dest_port [search index=firewall action=allowed | stats latest(_time) as allow_time by src_ip, dest_ip, dest_port] | where allow_time > block_time AND allow_time < (block_time + 3600)"}
{"instruction": "Identify users downloading malware then executing it", "input": "", "output": "index=proxy OR index=web (file_type=\"application/x-executable\" OR uri=\"*.exe\") | rex field=uri \"(?<filename>[^/]+\\.exe)$\" | eval download_time=_time | join user filename [search index=windows EventCode=4688 | rex field=Process_Name \"(?<exec_filename>[^\\\\]+)$\" | eval exec_time=_time | rename exec_filename as filename] | where exec_time > download_time AND exec_time < (download_time + 1800)"}
{"instruction": "Find registry persistence followed by scheduled task creation", "input": "", "output": "index=windows EventCode=4657 Object_Name=\"*\\CurrentVersion\\Run*\" | eval reg_time=_time | stats earliest(reg_time) as registry_modification by host, user | join host user [search index=windows EventCode=4698 | eval task_time=_time | stats earliest(task_time) as task_creation by host, user] | where task_creation > registry_modification AND task_creation < (registry_modification + 600)"}
{"instruction": "Detect account lockouts followed by password resets from different IP", "input": "", "output": "index=windows EventCode=4740 | eval lockout_time=_time | stats earliest(lockout_time) as locked_time, values(src_ip) as lockout_ip by user | join user [search index=windows EventCode=4724 | eval reset_time=_time | stats latest(reset_time) as password_reset_time, values(src_ip) as reset_ip by user] | where password_reset_time > locked_time AND password_reset_time < (locked_time + 7200) AND lockout_ip!=reset_ip"}
{"instruction": "Find rare parent-child process relationships", "input": "", "output": "index=windows EventCode=4688 | eval parent_child=Parent_Process_Name.\"|\".Process_Name | stats count by parent_child | where count < 5 | sort count"}
{"instruction": "Correlate USB device insertion with large file transfers", "input": "", "output": "index=windows EventCode=2003 | eval usb_time=_time | rex field=Message \"Device (?<device_id>[^\\s]+)\" | join host [search index=windows EventCode=4663 Object_Name=\"*\" Accesses=\"*WriteData*\" | eval file_time=_time | stats sum(File_Size) as total_size earliest(file_time) as first_write by host] | where first_write > usb_time AND first_write < (usb_time + 1800) AND total_size > 104857600"}
{"instruction": "Identify RDP sessions from unusual geolocations", "input": "", "output": "index=windows EventCode=4624 Logon_Type=10 | iplocation src_ip | join user [search index=windows EventCode=4624 Logon_Type=10 earliest=-90d latest=-1d | iplocation src_ip | stats values(Country) as normal_countries by user] | where NOT match(normal_countries, Country)"}
{"instruction": "Find service account usage from interactive logons", "input": "Service accounts pattern: svc_*, svc-*", "output": "index=windows EventCode=4624 (user=svc_* OR user=svc-*) (Logon_Type=2 OR Logon_Type=10 OR Logon_Type=11) | table _time, user, host, src_ip, Logon_Type"}
{"instruction": "Detect multiple distinct TTPs in MITRE ATT&CK framework within short timeframe", "input": "Using lookup: mitre_attack.csv", "output": "index=* earliest=-1h | lookup mitre_attack.csv signature as signature OUTPUT technique_id, tactic | where isnotnull(technique_id) | stats dc(technique_id) as unique_techniques, dc(tactic) as unique_tactics, values(technique_id) as techniques by host, user | where unique_techniques > 3 OR unique_tactics > 2"}
