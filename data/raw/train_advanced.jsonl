{"instruction": "Find failed logins followed by successful login from different IP", "input": "", "output": "index=* (action=failed OR action=failure) | stats earliest(_time) as first_fail, values(src_ip) as fail_ips by user | join user [search index=* action=success | stats latest(_time) as success_time, values(src_ip) as success_ips by user] | where success_time > first_fail | eval different_ip=if(fail_ips!=success_ips, \"Yes\", \"No\") | where different_ip=\"Yes\""}
{"instruction": "Correlate VPN connections with database access", "input": "", "output": "index=vpn action=connect | stats earliest(_time) as vpn_time by user, src_ip | join user [search index=database | stats latest(_time) as db_time by user] | where db_time > vpn_time AND db_time < (vpn_time + 3600)"}
{"instruction": "Find users accessing systems they've never accessed before", "input": "Baseline: last 90 days, Detection: last 24 hours", "output": "index=* earliest=-24h latest=now user=* dest=* | stats count by user, dest | join user dest type=left [search index=* earliest=-90d latest=-24h user=* dest=* | stats count as historical_count by user, dest] | where isnull(historical_count)"}
{"instruction": "Identify accounts with privileges not matching their department", "input": "Using lookup table: user_departments.csv", "output": "index=windows EventCode=4672 | lookup user_departments.csv user OUTPUT department, expected_privileges | where Privileges!=expected_privileges | table user, department, Privileges, expected_privileges"}
{"instruction": "Detect data transfer to new destinations", "input": "", "output": "index=network earliest=-1h bytes_out>1000000 | stats sum(bytes_out) as recent_bytes by dest_ip | join dest_ip type=left [search index=network earliest=-30d latest=-1h | stats count as historical_count by dest_ip] | where isnull(historical_count) | eval bytes_mb=round(recent_bytes/1048576, 2)"}
{"instruction": "Find processes spawned by web server executing unusual commands", "input": "", "output": "index=windows EventCode=4688 | rex field=Process_Command_Line \"(?<command>^\\S+)\" | search Parent_Process_Name=\"*w3wp.exe\" OR Parent_Process_Name=\"*httpd.exe\" OR Parent_Process_Name=\"*nginx.exe\" | where NOT match(command, \"(?i)(iisexpress|aspnet)\")"}
{"instruction": "Correlate endpoint alerts with network traffic", "input": "", "output": "index=edr alert_severity=high | eval alert_time=_time | join host [search index=network | eval network_time=_time] | where network_time > (alert_time - 300) AND network_time < (alert_time + 300) | stats values(dest_ip) as contacted_ips, values(dest_port) as contacted_ports by host, alert_name"}
{"instruction": "Identify privilege escalation followed by lateral movement", "input": "", "output": "index=windows EventCode=4672 Privileges=\"*SeDebugPrivilege*\" | eval escalation_time=_time | stats earliest(escalation_time) as esc_time by user | join user [search index=windows EventCode=4624 Logon_Type=3 | stats count dc(dest) as unique_systems earliest(_time) as first_lateral by user] | where first_lateral > esc_time AND first_lateral < (esc_time + 3600) AND unique_systems > 3"}
{"instruction": "Find suspicious file executions from temp directories with network activity", "input": "", "output": "index=windows EventCode=4688 (Process_Name=\"*\\Temp\\*\" OR Process_Name=\"*\\AppData\\Local\\Temp\\*\") | eval process_time=_time | join host [search index=network direction=outbound | eval network_time=_time] | where network_time > process_time AND network_time < (process_time + 60) | table host, user, Process_Name, dest_ip, dest_port"}
{"instruction": "Detect anomalous authentication times compared to user baseline", "input": "", "output": "index=* authentication action=success earliest=-24h | eval hour=strftime(_time, \"%H\") | join user [search index=* authentication action=success earliest=-30d latest=-1d | eval baseline_hour=strftime(_time, \"%H\") | stats values(baseline_hour) as normal_hours by user] | where NOT match(normal_hours, hour)"}
{"instruction": "Find commands executed within 5 minutes of opening a phishing email", "input": "", "output": "index=email subject=\"*urgent*\" OR subject=\"*invoice*\" attachment=*.exe | eval email_time=_time | join user [search index=windows EventCode=4688 | eval exec_time=_time] | where exec_time > email_time AND exec_time < (email_time + 300) | table user, subject, attachment, Process_Name, Process_Command_Line"}
{"instruction": "Correlate failed firewall rules with subsequent successful connections", "input": "", "output": "index=firewall action=blocked | stats earliest(_time) as block_time by src_ip, dest_ip, dest_port | join src_ip dest_ip dest_port [search index=firewall action=allowed | stats latest(_time) as allow_time by src_ip, dest_ip, dest_port] | where allow_time > block_time AND allow_time < (block_time + 3600)"}
{"instruction": "Identify users downloading malware then executing it", "input": "", "output": "index=proxy OR index=web (file_type=\"application/x-executable\" OR uri=\"*.exe\") | rex field=uri \"(?<filename>[^/]+\\.exe)$\" | eval download_time=_time | join user filename [search index=windows EventCode=4688 | rex field=Process_Name \"(?<exec_filename>[^\\\\]+)$\" | eval exec_time=_time | rename exec_filename as filename] | where exec_time > download_time AND exec_time < (download_time + 1800)"}
{"instruction": "Find registry persistence followed by scheduled task creation", "input": "", "output": "index=windows EventCode=4657 Object_Name=\"*\\CurrentVersion\\Run*\" | eval reg_time=_time | stats earliest(reg_time) as registry_modification by host, user | join host user [search index=windows EventCode=4698 | eval task_time=_time | stats earliest(task_time) as task_creation by host, user] | where task_creation > registry_modification AND task_creation < (registry_modification + 600)"}
{"instruction": "Detect account lockouts followed by password resets from different IP", "input": "", "output": "index=windows EventCode=4740 | eval lockout_time=_time | stats earliest(lockout_time) as locked_time, values(src_ip) as lockout_ip by user | join user [search index=windows EventCode=4724 | eval reset_time=_time | stats latest(reset_time) as password_reset_time, values(src_ip) as reset_ip by user] | where password_reset_time > locked_time AND password_reset_time < (locked_time + 7200) AND lockout_ip!=reset_ip"}
{"instruction": "Find rare parent-child process relationships", "input": "", "output": "index=windows EventCode=4688 | eval parent_child=Parent_Process_Name.\"|\".Process_Name | stats count by parent_child | where count < 5 | sort count"}
{"instruction": "Correlate USB device insertion with large file transfers", "input": "", "output": "index=windows EventCode=2003 | eval usb_time=_time | rex field=Message \"Device (?<device_id>[^\\s]+)\" | join host [search index=windows EventCode=4663 Object_Name=\"*\" Accesses=\"*WriteData*\" | eval file_time=_time | stats sum(File_Size) as total_size earliest(file_time) as first_write by host] | where first_write > usb_time AND first_write < (usb_time + 1800) AND total_size > 104857600"}
{"instruction": "Identify RDP sessions from unusual geolocations", "input": "", "output": "index=windows EventCode=4624 Logon_Type=10 | iplocation src_ip | join user [search index=windows EventCode=4624 Logon_Type=10 earliest=-90d latest=-1d | iplocation src_ip | stats values(Country) as normal_countries by user] | where NOT match(normal_countries, Country)"}
{"instruction": "Find service account usage from interactive logons", "input": "Service accounts pattern: svc_*, svc-*", "output": "index=windows EventCode=4624 (user=svc_* OR user=svc-*) (Logon_Type=2 OR Logon_Type=10 OR Logon_Type=11) | table _time, user, host, src_ip, Logon_Type"}
{"instruction": "Detect multiple distinct TTPs in MITRE ATT&CK framework within short timeframe", "input": "Using lookup: mitre_attack.csv", "output": "index=* earliest=-1h | lookup mitre_attack.csv signature as signature OUTPUT technique_id, tactic | where isnotnull(technique_id) | stats dc(technique_id) as unique_techniques, dc(tactic) as unique_tactics, values(technique_id) as techniques by host, user | where unique_techniques > 3 OR unique_tactics > 2"}
{"input": "Detect beaconing behavior using statistical analysis of connection intervals", "output": "index=zeek sourcetype=zeek_conn | bucket _time span=1m | stats count by _time, id.orig_h, id.resp_h, id.resp_p | eventstats avg(count) as avg_count, stdev(count) as stdev_count by id.orig_h, id.resp_h, id.resp_p | eval variance_coefficient=stdev_count/avg_count | where variance_coefficient<0.2 AND avg_count>1 | stats dc(_time) as time_periods, avg(avg_count) as beacon_frequency by id.orig_h, id.resp_h, id.resp_p | where time_periods>100"}
{"input": "Identify domain generation algorithm DGA activity using entropy and pattern analysis", "output": "index=zeek sourcetype=zeek_dns rcode_name=\"NXDOMAIN\" | rex field=query \"^(?<subdomain>[^\\.]+)\\.\" | eval qlen=len(subdomain) | where qlen>15 | eval consonants=mvcount(split(lower(subdomain),\"bcdfghjklmnpqrstvwxyz\"))-1 | eval vowels=mvcount(split(lower(subdomain),\"aeiou\"))-1 | eval consonant_ratio=consonants/(consonants+vowels) | where consonant_ratio>0.7 | stats count, dc(query) as unique_domains by id.orig_h | where unique_domains>20"}
{"input": "Hunt for lateral movement using authentication and process creation correlation", "output": "(sourcetype=WinEventLog:Security EventCode=4624 Logon_Type=3) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 (Image=\"*psexec.exe\" OR ParentImage=\"*services.exe\")) | eval host=coalesce(ComputerName,Computer) | eval user=coalesce(Account_Name,User) | transaction host user maxspan=5m | where mvcount(EventCode)>1 | stats count, values(host) as affected_hosts, values(Image) as processes_executed by user | where mvcount(affected_hosts)>3"}
{"input": "Detect data staging and exfiltration using file activity and network correlation", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11 (TargetFilename=\"*.zip\" OR TargetFilename=\"*.rar\" OR TargetFilename=\"*.7z\")) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=3 NOT (DestinationIp=\"10.*\" OR DestinationIp=\"172.16.*\" OR DestinationIp=\"192.168.*\"))) | transaction Computer maxspan=30m | where mvcount(EventCode)>1 | eval archive_created=if(mvfind(EventCode,\"11\")>=0,\"yes\",\"no\") | eval external_connection=if(mvfind(EventCode,\"3\")>=0,\"yes\",\"no\") | where archive_created=\"yes\" AND external_connection=\"yes\" | table _time Computer User TargetFilename DestinationIp DestinationPort"}
{"input": "Identify process injection using CreateRemoteThread and suspicious access patterns", "output": "sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" (EventCode=8 OR EventCode=10) | eval technique=case(EventCode=8,\"CreateRemoteThread\",EventCode=10,\"ProcessAccess\",1=1,\"Unknown\") | stats values(technique) as techniques, values(SourceImage) as source_processes, values(TargetImage) as target_processes, count by Computer | where mvcount(techniques)>1 AND (mvfind(target_processes,\"*lsass.exe\")>=0 OR mvfind(target_processes,\"*csrss.exe\")>=0) | table Computer source_processes target_processes techniques count"}
{"input": "Detect living off the land LOLBin attack chains using process relationships", "output": "sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 | eval is_lolbin=if(match(Image,\"(?i)(certutil|bitsadmin|mshta|regsvr32|rundll32|wmic|cscript|wscript|powershell|cmd)\\.exe\"),1,0) | where is_lolbin=1 | eval suspicious_args=case(match(CommandLine,\"(?i)(download|http|ftp|script)\"),\"network_download\",match(CommandLine,\"(?i)(encode|decode|base64)\"),\"encoding\",match(CommandLine,\"(?i)(-enc|-e |invoke)\"),\"obfuscation\",1=1,\"none\") | where suspicious_args!=\"none\" | transaction Computer ProcessGuid maxspan=10m | where mvcount(Image)>2 | table _time Computer User ProcessGuid Image CommandLine suspicious_args"}
{"input": "Find DNS tunneling using query length entropy and volume analysis", "output": "index=zeek sourcetype=zeek_dns | eval qlen=len(query) | stats count, avg(qlen) as avg_length, stdev(qlen) as length_variance, dc(query) as unique_queries by id.orig_h | where count>1000 AND avg_length>50 AND unique_queries>500"}
{"input": "Detect credential dumping using LSASS access patterns and process behavior", "output": "(sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=10 TargetImage=\"*\\\\lsass.exe\" (GrantedAccess=\"0x1010\" OR GrantedAccess=\"0x1410\" OR GrantedAccess=\"0x1438\")) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 CommandLine=\"*lsass*\" (CommandLine=\"*dump*\" OR CommandLine=\"*procdump*\")) | stats values(EventCode) as event_codes, values(SourceImage) as accessing_processes, values(CommandLine) as commands, values(GrantedAccess) as access_rights, count by Computer | where mvcount(event_codes)>=1 | eval risk_score=case(mvfind(accessing_processes,\"(?i)mimikatz\")>=0,100,mvfind(commands,\"(?i)dump\")>=0,80,match(access_rights,\"0x1410|0x1438\"),70,1=1,50) | where risk_score>60"}
{"input": "Hunt for webshell activity using HTTP patterns and file creation correlation", "output": "((index=zeek sourcetype=zeek_http method=\"POST\" uri=\"*.php*\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11 TargetFilename=\"*\\\\inetpub\\\\*\" TargetFilename=\"*.php\")) | eval activity_type=case(isnotnull(method),\"http_post\",isnotnull(TargetFilename),\"file_creation\",1=1,\"unknown\") | eval indicator=coalesce(uri,TargetFilename) | rex field=indicator \"/(?<filename>[^/]+\\.php)\" | stats values(activity_type) as activities, values(id.orig_h) as source_ips, values(user_agent) as user_agents, values(Computer) as hosts, count by filename | where mvcount(activities)>1 OR mvfind(user_agents,\"(?i)(curl|wget|python|scanner)\")>=0"}
{"input": "Identify Kerberoasting attacks using service ticket request patterns", "output": "sourcetype=WinEventLog:Security EventCode=4769 Ticket_Encryption_Type=\"0x17\" NOT Service_Name=\"*$\" | stats count, values(Service_Name) as services, dc(Service_Name) as unique_services, values(Client_Address) as client_ips by Account_Name | where unique_services>5 OR count>20 | join type=left Account_Name [search sourcetype=WinEventLog:Security EventCode=4768 | stats count as tgt_requests by Account_Name] | eval tgs_to_tgt_ratio=count/tgt_requests | where tgs_to_tgt_ratio>10"}
{"input": "Detect complete attack chain from initial access to data exfiltration", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11 TargetFilename=\"*\\\\Downloads\\\\*.exe\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=3) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11 (TargetFilename=\"*.zip\" OR TargetFilename=\"*.rar\"))) | transaction Computer maxspan=1h | eval stage1_download=if(mvfind(TargetFilename,\"*\\\\Downloads\\\\*.exe\")>=0,\"yes\",\"no\") | eval stage2_execution=if(mvcount(Image)>1,\"yes\",\"no\") | eval stage3_external_conn=if(mvfind(DestinationIp,\"*\")>=0 AND NOT match(DestinationIp,\"^(10\\.|172\\.16\\.|192\\.168\\.)\"),\"yes\",\"no\") | eval stage4_archive=if(mvfind(TargetFilename,\"*\\.zip|*\\.rar\")>=0,\"yes\",\"no\") | where stage1_download=\"yes\" AND stage2_execution=\"yes\" AND stage3_external_conn=\"yes\""}
{"input": "Identify reconnaissance to exploitation workflow", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 (CommandLine=\"*whoami*\" OR CommandLine=\"*net user*\" OR CommandLine=\"*ipconfig*\")) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 (CommandLine=\"*mimikatz*\" OR CommandLine=\"*procdump*\"))) | transaction Computer User maxspan=30m | where mvcount(CommandLine)>3 | eval recon_commands=mvfilter(match(CommandLine,\"(?i)(whoami|net user|ipconfig)\")) | eval exploit_commands=mvfilter(match(CommandLine,\"(?i)(mimikatz|procdump|dump)\")) | where mvcount(recon_commands)>0 AND mvcount(exploit_commands)>0"}
{"input": "Track privilege escalation to lateral movement sequence", "output": "((sourcetype=WinEventLog:Security EventCode=4672) OR (sourcetype=WinEventLog:Security EventCode=4624 Logon_Type=3) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=3 DestinationPort=445)) | transaction Account_Name maxspan=20m | where mvcount(EventCode)>2 | eval priv_escalation=if(mvfind(EventCode,\"4672\")>=0,1,0) | eval lateral_logon=if(mvfind(EventCode,\"4624\")>=0,1,0) | eval smb_connection=if(mvfind(EventCode,\"3\")>=0,1,0) | where priv_escalation=1 AND lateral_logon=1"}
{"input": "Detect persistence establishment after initial compromise", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 Image=\"*\\\\Temp\\\\*\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=13 TargetObject=\"*\\\\Run*\") OR (sourcetype=WinEventLog:System EventCode=7045)) | transaction Computer maxspan=15m | where mvcount(EventCode)>1 | eval initial_exec=if(mvfind(Image,\"*\\\\Temp\\\\*\")>=0,\"yes\",\"no\") | eval registry_persist=if(mvfind(EventCode,\"13\")>=0,\"yes\",\"no\") | eval service_persist=if(mvfind(EventCode,\"7045\")>=0,\"yes\",\"no\") | where initial_exec=\"yes\" AND (registry_persist=\"yes\" OR service_persist=\"yes\")"}
{"input": "Hunt for phishing to credential theft to lateral movement", "output": "((sourcetype=email subject=\"*invoice*\" OR subject=\"*urgent*\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11 TargetFilename=\"*\\\\Downloads\\\\*\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=10 TargetImage=\"*lsass.exe\") OR (sourcetype=WinEventLog:Security EventCode=4624 Logon_Type=3)) | transaction User maxspan=2h | eval phase1_email=if(isnotnull(subject),\"detected\",\"none\") | eval phase2_download=if(mvfind(EventCode,\"11\")>=0,\"detected\",\"none\") | eval phase3_cred_dump=if(mvfind(EventCode,\"10\")>=0,\"detected\",\"none\") | eval phase4_lateral=if(mvfind(EventCode,\"4624\")>=0,\"detected\",\"none\") | where phase3_cred_dump=\"detected\" OR phase4_lateral=\"detected\""}
{"input": "Detect complete attack chain from initial access to data exfiltration", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11 TargetFilename=\"*\\\\Downloads\\\\*.exe\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=3) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11 (TargetFilename=\"*.zip\" OR TargetFilename=\"*.rar\"))) | transaction Computer maxspan=1h | eval stage1_download=if(mvfind(TargetFilename,\"*\\\\Downloads\\\\*.exe\")>=0,\"yes\",\"no\") | eval stage2_execution=if(mvcount(Image)>1,\"yes\",\"no\") | eval stage3_external_conn=if(mvfind(DestinationIp,\"*\")>=0 AND NOT match(DestinationIp,\"^(10\\.|172\\.16\\.|192\\.168\\.)\"),\"yes\",\"no\") | eval stage4_archive=if(mvfind(TargetFilename,\"*\\.zip|*\\.rar\")>=0,\"yes\",\"no\") | where stage1_download=\"yes\" AND stage2_execution=\"yes\" AND stage3_external_conn=\"yes\""}
{"input": "Identify reconnaissance to exploitation workflow", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 (CommandLine=\"*whoami*\" OR CommandLine=\"*net user*\" OR CommandLine=\"*ipconfig*\")) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 (CommandLine=\"*mimikatz*\" OR CommandLine=\"*procdump*\"))) | transaction Computer User maxspan=30m | where mvcount(CommandLine)>3 | eval recon_commands=mvfilter(match(CommandLine,\"(?i)(whoami|net user|ipconfig)\")) | eval exploit_commands=mvfilter(match(CommandLine,\"(?i)(mimikatz|procdump|dump)\")) | where mvcount(recon_commands)>0 AND mvcount(exploit_commands)>0"}
{"input": "Track privilege escalation to lateral movement sequence", "output": "((sourcetype=WinEventLog:Security EventCode=4672) OR (sourcetype=WinEventLog:Security EventCode=4624 Logon_Type=3) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=3 DestinationPort=445)) | transaction Account_Name maxspan=20m | where mvcount(EventCode)>2 | eval priv_escalation=if(mvfind(EventCode,\"4672\")>=0,1,0) | eval lateral_logon=if(mvfind(EventCode,\"4624\")>=0,1,0) | eval smb_connection=if(mvfind(EventCode,\"3\")>=0,1,0) | where priv_escalation=1 AND lateral_logon=1"}
{"input": "Detect persistence establishment after initial compromise", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 Image=\"*\\\\Temp\\\\*\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=13 TargetObject=\"*\\\\Run*\") OR (sourcetype=WinEventLog:System EventCode=7045)) | transaction Computer maxspan=15m | where mvcount(EventCode)>1 | eval initial_exec=if(mvfind(Image,\"*\\\\Temp\\\\*\")>=0,\"yes\",\"no\") | eval registry_persist=if(mvfind(EventCode,\"13\")>=0,\"yes\",\"no\") | eval service_persist=if(mvfind(EventCode,\"7045\")>=0,\"yes\",\"no\") | where initial_exec=\"yes\" AND (registry_persist=\"yes\" OR service_persist=\"yes\")"}
{"input": "Hunt for phishing to credential theft to lateral movement", "output": "((sourcetype=email subject=\"*invoice*\" OR subject=\"*urgent*\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11 TargetFilename=\"*\\\\Downloads\\\\*\") OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=10 TargetImage=\"*lsass.exe\") OR (sourcetype=WinEventLog:Security EventCode=4624 Logon_Type=3)) | transaction User maxspan=2h | eval phase1_email=if(isnotnull(subject),\"detected\",\"none\") | eval phase2_download=if(mvfind(EventCode,\"11\")>=0,\"detected\",\"none\") | eval phase3_cred_dump=if(mvfind(EventCode,\"10\")>=0,\"detected\",\"none\") | eval phase4_lateral=if(mvfind(EventCode,\"4624\")>=0,\"detected\",\"none\") | where phase3_cred_dump=\"detected\" OR phase4_lateral=\"detected\""}
{"input": "Perform behavioral baseline deviation analysis for user activity", "output": "sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 earliest=-30d | eval hour=tonumber(strftime(_time,\"%H\")) | eventstats avg(eval(hour)) as avg_hour, stdev(eval(hour)) as stdev_hour by User | eval z_score=abs(hour-avg_hour)/stdev_hour | where z_score>3 | stats count, values(Computer) as computers, values(Image) as processes, avg(hour) as current_avg_hour, avg(avg_hour) as baseline_hour, max(z_score) as max_deviation by User | where count>5 | eval deviation_hours=abs(current_avg_hour-baseline_hour) | sort -max_deviation"}
{"input": "Identify impossible travel using authentication logs", "output": "sourcetype=WinEventLog:Security EventCode=4624 Logon_Type=10 | iplocation Source_Network_Address | eval location=City.\",\".Country | streamstats current=f last(location) as previous_location, last(_time) as previous_time by Account_Name | where location!=previous_location | eval time_diff=(_time-previous_time)/3600 | eval distance=case(location=\"New York,US\" AND previous_location=\"London,GB\",3459,location=\"Tokyo,JP\" AND previous_location=\"Sydney,AU\",4863,1=1,1000) | eval required_speed=distance/time_diff | where required_speed>500"}
{"input": "Detect anomalous data volume transfer patterns", "output": "index=zeek sourcetype=zeek_conn earliest=-30d | stats sum(orig_bytes) as total_bytes by id.orig_h, _time | streamstats window=7 avg(total_bytes) as avg_bytes, stdev(total_bytes) as stdev_bytes by id.orig_h | eval z_score=(total_bytes-avg_bytes)/stdev_bytes | where z_score>3 | eval bytes_GB=round(total_bytes/1073741824,2) | table _time id.orig_h bytes_GB avg_bytes z_score"}
{"input": "Identify users with abnormal process execution patterns", "output": "sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 earliest=-30d | stats dc(Image) as unique_processes by User, _time | streamstats window=14 avg(unique_processes) as baseline_processes, stdev(unique_processes) as stdev_processes by User | eval deviation=(unique_processes-baseline_processes)/stdev_processes | where deviation>2 | stats count, avg(unique_processes) as current_unique, avg(baseline_processes) as baseline, max(deviation) as max_deviation by User"}
{"input": "Detect sudden increases in failed authentication attempts", "output": "sourcetype=WinEventLog:Security (EventCode=4625 OR EventCode=4624) | eval auth_result=if(EventCode=4625,\"failure\",\"success\") | timechart span=1h count by auth_result | streamstats window=24 avg(failure) as avg_failures, stdev(failure) as stdev_failures | eval z_score=(failure-avg_failures)/stdev_failures | where z_score>2"}
{"input": "Hunt for anomalous DNS query patterns using time series analysis", "output": "index=zeek sourcetype=zeek_dns earliest=-30d | timechart span=1h count by id.orig_h | untable _time host query_count | streamstats window=168 avg(query_count) as baseline_queries, stdev(query_count) as stdev_queries by host | eval anomaly_score=(query_count-baseline_queries)/stdev_queries | where anomaly_score>3 | table _time host query_count baseline_queries anomaly_score"}
{"input": "Build comprehensive attack timeline using multi-source event correlation", "output": "(sourcetype=WinEventLog:Security (EventCode=4624 OR EventCode=4625 OR EventCode=4672)) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" (EventCode=1 OR EventCode=3 OR EventCode=11)) OR (index=zeek sourcetype=zeek_conn) OR (index=suricata event_type=alert) | eval event_description=case(EventCode=\"4624\",\"Login Success: \".Account_Name,EventCode=\"4625\",\"Login Failed: \".Account_Name,EventCode=\"4672\",\"Special Privileges: \".Account_Name,EventCode=\"1\",\"Process: \".Image,EventCode=\"3\",\"Network: \".Image.\" -> \".DestinationIp.\":\".DestinationPort,EventCode=\"11\",\"File: \".TargetFilename,sourcetype=\"zeek_conn\",\"Flow: \".id.orig_h.\" -> \".id.resp_h.\":\".id.resp_p,event_type=\"alert\",\"Alert: \".alert.signature,1=1,\"Unknown\") | eval host=coalesce(ComputerName,Computer,id.orig_h,src_ip) | where host=\"INVESTIGATED-HOST\" | sort _time | table _time sourcetype host event_description"}
{"input": "Correlate endpoint and network data for APT detection", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=3) OR (index=zeek sourcetype=zeek_http) OR (index=suricata event_type=alert alert.category=\"*APT*\")) | eval identifier=coalesce(Computer,id.orig_h,src_ip) | transaction identifier maxspan=1h | eval has_process=if(mvfind(EventCode,\"1\")>=0,1,0) | eval has_network=if(mvfind(EventCode,\"3\")>=0 OR isnotnull(host),1,0) | eval has_alert=if(event_type=\"alert\",1,0) | where has_process=1 AND has_network=1 AND has_alert=1"}
{"input": "Detect supply chain compromise using hash correlation and rare process analysis", "output": "sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=1 | rex field=Hashes \"SHA256=(?<sha256>[A-F0-9]{64})\" | where isnotnull(sha256) | stats count, values(Computer) as hosts, values(CommandLine) as command_lines, dc(Computer) as host_count, earliest(_time) as first_seen, latest(_time) as last_seen by Image, sha256 | where host_count<5 AND host_count>1 | join type=left sha256 [| inputlookup threat_intel.csv | fields sha256 threat_name threat_category] | eval threat_status=if(isnotnull(threat_name),\"Known Threat: \".threat_name,\"Unknown/Rare Binary\") | eval investigation_priority=case(isnotnull(threat_name),\"Critical\",host_count=1,\"High\",host_count<5,\"Medium\",1=1,\"Low\") | convert ctime(first_seen) ctime(last_seen)"}
{"input": "Hunt for Golden Ticket attacks using Kerberos anomaly detection", "output": "sourcetype=WinEventLog:Security EventCode=4624 Logon_Type=3 Authentication_Package=\"Kerberos\" | rex field=Security_ID \"(?<domain>[^\\\\]+)\\\\(?<user>.+)\" | stats count, values(Workstation_Name) as workstations, values(Source_Network_Address) as source_ips, dc(Workstation_Name) as unique_workstations by user | where unique_workstations>10 | join type=inner user [search sourcetype=WinEventLog:Security EventCode=4768 | stats min(_time) as tgt_time by Account_Name | rename Account_Name as user] | eval time_diff=_time-tgt_time | where time_diff>86400 | eval days_since_tgt=round(time_diff/86400,1)"}
{"input": "Correlate file creation network connections and registry modifications for backdoor detection", "output": "((sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=11) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=3) OR (sourcetype=\"XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\" EventCode=13 TargetObject=\"*\\\\Run*\")) | transaction Computer ProcessGuid maxspan=10m | where mvcount(EventCode)>2 | eval has_file=if(mvfind(EventCode,\"11\")>=0,1,0) | eval has_network=if(mvfind(EventCode,\"3\")>=0,1,0) | eval has_persistence=if(mvfind(EventCode,\"13\")>=0,1,0) | where has_file=1 AND has_network=1 AND has_persistence=1"}